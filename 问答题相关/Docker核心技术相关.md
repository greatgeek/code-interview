# Docker核心技术相关

## 内核与文件系统

Linux操作系统包括两个主要部分：内核（Kernel）和文件系统。

1. **内核**：内核是操作系统的核心，控制计算机硬件资源并提供上层应用程序接口。例如，它负责调度并管理CPU的进程和任务、管理内存、硬盘、外设等硬件资源。此外，它还提供了系统调用接口，应用程序可以通过这些接口请求内核提供的服务。Linux内核是开源的，可以在不同的硬件平台上运行，如个人电脑、服务器、移动设备等。
2. **文件系统**：文件系统是操作系统用来控制如何将数据存储到磁盘上，以及如何检索这些数据的一种机制。Linux文件系统对所有存储设备使用一种统一的目录结构，即使在网络上或者插入新的设备时仍然保持相同的结构，为用户和程序提供了方便的数据管理方式。Linux系统支持许多不同类型的文件系统，如ext3、ext4、XFS、Btrfs等。

在Linux的设计中，所有设备都被视为文件，这种设计使得用户和程序可以采用统一且简单的方式来访问各种资源。这是通过设备文件和特殊文件来实现的，它们在文件系统中有自己的路径，但实际上是内核中设备驱动程序的一种接口。

所以，内核和文件系统是Linux操作系统中的关键部分，满足了用户对于硬件设备的控制需求和对文件的组织、管理需求。

## cgroup 与 chroot

**cgroup**：cgroup (控制组)是Linux内核的功能，用于限制并隔离一组进程对系统资源（如CPU，内存，磁盘I/O等）的使用。例如，Docker等容器技术就使用cgroup来限制和隔离容器的资源使用。通过cgroup，系统管理员可以精细地控制资源的分配，提高系统整体的稳定性和效率。

**chroot**：chroot是一种在Unix和类Unix操作系统中改变进程运行时根目录的操作。该操作的效果是建立一种虚拟环境，在该环境中进程无法访问实际文件系统中位于其根目录之外的文件和目录。它经常被应用在系统安全和系统隔离方面，例如，创建一种"沙盒"环境来运行不信任的程序。

总的来说，内核和文件系统是操作系统的基础组成部分，而cgroup和chroot是内核提供的一些可用于进程控制和资源隔离的高级功能。

## Namespace 的隔离技术

在 Linux 中，Namespace 是用于隔离系统资源的关键技术。至今，Linux 内核提供了以下七种不同的 Namespaces：

1. Mount（mnt）：Mount Namespace 隔离了文件系统挂载点视图，允许每个命名空间内可以有不同的文件系统视图。
2. Process ID （pid）：PID Namespace 隔离了进程 ID，允许每个 Namespace 不同的进程有相同的 PID。
3. Network（net）：Network Namespace 隔离了网络设备、IP 地址、路由表等网络栈的状态，允许每个命名空间内的进程拥有独立的网络栈、网络设备和网络配置，使得每个命名空间内可以有独立的网络环境。
4. InterProcess Communication（ipc）：允许每个命名空间内的进程拥有独立的进程间通信机制，如System V IPC和POSIX消息队列。
5. **UTS**：UTS Namespace允许每个Namespace有自己的主机名和域名。
6. **User ID**（user）: User Namespace隔离了用户和用户组ID，它可以将一个Namespace的用户和组ID映射到别的Namespace的用户和用户组ID。
7. **Cgroup Namespace**：隔离 cgroup 根目录，使得在不同 Cgroup Namespace 中的进程看到的 cgroup 层次结构不同。
8. **Time Namespace**（自 Linux 5.6 起）：隔离时间命名空间，用于隔离时间相关属性，如系统时间、定时器等。

| 分类               | 系统调用参数  |
| ------------------ | ------------- |
| Mount namespaces   | CLONE_NEWNS   |
| UTS namespaces     | CLONE_NEWUTS  |
| IPC namespaces     | CLONE_NEWIPC  |
| PID namespaces     | CLONE_NEWPID  |
| Network namespaces | CLONE_NEWNET  |
| User namespaces    | CLONE_NEWUSER |
| Cgroup Namespace   |               |
| Time Namespace     |               |

> 当你走进一座神秘的实验室，你发现一位名叫科林的天才科学家正在进行一项前所未有的实验。科林正在努力创造一种能够在不同的维度之间旅行的装置。他的目标是在这些维度之间实现资源和信息的隔离，以实现更高级的安全性和控制。
>
> 科林的实验室充满了奇怪的装置和绚丽的光芒，而在墙上，你注意到了八个奇特的符号，每个符号都代表着不同的概念。科林开始讲述他的故事：
>
> "嗨，朋友。欢迎来到我的实验室。我将向你介绍一项伟大的发现：'维度隔离装置'。这项装置可以将事物隔离到不同的维度中，就像是不同的世界。"
>
> 科林开始详细介绍每个符号背后的维度：
>
> 1. **PID 维度**：这是一个隔离进程的维度。就像每个人都有独一无二的身份证号码一样，每个进程在不同的维度都有不同的进程 ID。
> 2. **Mount 维度**：这个维度让我们像魔法一样隔离文件系统。不同的维度有不同的文件系统树，就像不同的魔法世界有不同的地图。
> 3. **UTS 维度**：这是隔离主机名和域名的维度。每个维度都可以有不同的名字，就像不同的维度有不同的地名和语言。
> 4. **IPC 维度**：在这个维度中，我们可以隔离进程间通信。不同的维度有不同的对话方式，就像不同的维度有不同的语言。
> 5. **Network 维度**：这个维度让我们控制网络。每个维度有自己的网络，就像每个城市都有自己的互联网。
> 6. **User 维度**：在这个维度中，我们可以改变身份。每个维度有不同的用户，就像不同的人生中有不同的身份。
> 7. **Cgroup 维度**：这是隔离资源的维度。每个维度有不同的资源分配，就像每个家庭有不同的预算。
> 8. **Time 维度**：最近我刚刚成功创造了这个维度。在这个维度中，我们可以隔离时间。每个维度有自己的时间线，就像不同的故事有不同的时间。
>
> 科林解释说，通过将这些维度组合在一起，他可以创造出一个更安全、更有控制力的环境。他期待着他的维度隔离装置能够为世界带来更多的可能性和机会。
>
> 你留下了记录，将这个故事记在了笔记本上，这个神秘的实验室和科林的发现将成为你心中永不磨灭的记忆。

### PID 为 1 有什么用？

在传统的 UNIX 系统中，PID 为 1 的进程是 init，地位非常特殊。他作为所有进程的父进程，有很多特权（比如：屏蔽信号等），另外，其还会检查所有进程的状态，我们知道，如果某个子进程脱离了父进程（父进程没有 wait 它），那么 init 就会负责回收资源并结束这个子进程。所以，要做到进程空间的隔离，首先要创建出 PID 为 1 的进程，最好就像是 chroot 那样，把子进程的 PID 在容器内变成 1。

## Docker 的 NAT 模式与 overlay 模式

Docker在容器网络中使用了多种网络模式，其中NAT（Network Address Translation）模式和Overlay模式是最常见的两种。以下是它们的详细描述和对比：

### 1. NAT模式（通常称为bridge模式）：

- **工作原理**：当容器启动时，它将连接到一个默认的网络桥（docker0）。每个新容器都会在这个桥上获得一个内部IP地址，然后Docker使用NAT将这些容器的流量转发到主机的外部IP地址。
  
- **用途**：NAT或bridge模式是Docker的默认网络设置，适合于单机上的容器通信。

- **限制**：
  - 因为它是基于主机的网络桥，所以跨多个主机的容器间通信可能会变得复杂。
  - 需要手动管理端口映射，以允许外部访问容器服务。

### 2. Overlay模式：

- **工作原理**：Overlay网络使用网络层2（数据链路层）的覆盖技术，允许在多个Docker宿主机上的容器之间创建一个虚拟网络，即使这些宿主机在物理上是分隔的。它通常使用VXLAN技术在主机之间封装网络流量。

- **用途**：当需要在跨多个宿主机上的容器之间进行通信时，overlay网络是首选。这在使用像Docker Swarm这样的集群管理工具时特别有用。

- **特点**：
  - 可扩展性：允许在跨多个主机、数据中心和云提供商的容器之间通信。
  - 解耦：Overlay网络与底层物理或云网络的细节解耦，为容器提供一致的网络接口。
  
- **限制**：
  - Overlay网络会引入一些额外的网络开销，因为它在宿主机之间封装和解封装网络流量。
  - 需要跨主机的数据存储和网络通信支持（例如，Swarm需要K/V存储如Consul、Etcd或ZooKeeper来维护网络状态）。

### 总结：
选择使用NAT模式还是Overlay模式取决于您的需求。对于单机上的简单Docker部署，NAT或bridge模式可能就足够了。但是，对于跨多个宿主机或数据中心的复杂部署，Overlay模式提供了一个强大和灵活的解决方案。
